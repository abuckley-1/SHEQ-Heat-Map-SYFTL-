import pandas as pd
import json, re
from datetime import datetime, timedelta

# Load the sheet with headers on row 2
xlsx_path = "NEW FORM Accident and Incident Investigations Action Tracker_ST0335-25x26sx.xlsx"
df = pd.read_excel(xlsx_path, sheet_name="Accident & Incident Detail", header=1, engine="openpyxl")
df = df.dropna(how="all")
df.columns = [str(c).strip() for c in df.columns]

col_map = {
    "DateTime": "Date",
    "Reference": "Accident/ Incident  Reference",
    "Incident": "Incident",
    "Location": "Location",
    "Direction": "Direction of Travel",
    "RIDDOR_SMIS": "RIDDOR/SMIS",
    "WKT": "Lan & Lon"
}

# Helpers
POINT_RE = re.compile(r"point\\s*\\(\\s*([\\-0-9\\.]+)\\s+([\\-0-9\\.]+)\\s*\\)", re.I)

def parse_wkt_point(wkt):
    if pd.isna(wkt): return None, None
    s = str(wkt).strip()
    if not s: return None, None
    m = POINT_RE.match(s.replace("POINT (", "POINT("))
    return (float(m.group(1)), float(m.group(2))) if m else (None, None)

def normalize_direction(val):
    if pd.isna(val): return ""
    v = str(val).strip()
    u = re.sub(r"\\s+", "", v).upper()
    if u in {"I/B","IB","INBOUND"}: return "Inbound"
    if u in {"O/B","OB","OUTBOUND"}: return "Outbound"
    if u in {"WRONGDIRECTION","WRONG-DIRECTION"}: return "Wrong Direction"
    return v.title() if v.lower() in {"inbound","outbound","wrong direction"} else v

def excel_serial_to_iso(val):
    if pd.isna(val): return ""
    try:
        if isinstance(val, (int, float)):
            base = datetime(1899, 12, 30)
            dt = base + timedelta(days=float(val))
            return dt.strftime("%Y-%m-%dT%H:%M:%SZ")
        dt = pd.to_datetime(val, errors="coerce")
        return dt.strftime("%Y-%m-%dT%H:%M:%SZ") if not pd.isna(dt) else str(val)
    except Exception:
        return str(val)

features = []
for _, row in df.iterrows():
    lon, lat = parse_wkt_point(row[col_map["WKT"]])
    geometry = {"type": "Point", "coordinates": [lon if lon is not None else None,
                                                  lat if lat is not None else None]}
    properties = {
        "DateTime": excel_serial_to_iso(row[col_map["DateTime"]]),
        "Reference": "" if pd.isna(row[col_map["Reference"]]) else str(row[col_map["Reference"]]),
        "Incident": "" if pd.isna(row[col_map["Incident"]]) else str(row[col_map["Incident"]]),
        "Location": "" if pd.isna(row[col_map["Location"]]) else str(row[col_map["Location"]]).strip(),
        "Direction": normalize_direction(row[col_map["Direction"]]),
        "RIDDOR_SMIS": "" if pd.isna(row[col_map["RIDDOR_SMIS"]]) else str(row[col_map["RIDDOR_SMIS"]]),
    }
    features.append({"type": "Feature", "geometry": geometry, "properties": properties})

feature_collection = {"type": "FeatureCollection", "features": features}
with open("incidents.geojson", "w", encoding="utf-8") as f:
    json.dump(feature_collection, f, ensure_ascii=False, indent=2)
